services:
  redis:
    image: redis:8.4.0
    container_name: superset_cache
    restart: unless-stopped
    expose:
      - 6379

  db:
    image: postgres:16
    container_name: superset_db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=superset
      - POSTGRES_USER=superset
      - POSTGRES_PASSWORD=supersecret
      - POSTGRES_PORT=5432

  superset:
    build: .
    container_name: superset_app
    restart: unless-stopped
    ports:
      - 8088:8088
    environment:
      - DATABASE_DIALECT=postgresql
      - DATABASE_USER=superset
      - DATABASE_PASSWORD=supersecret
      - DATABASE_HOST=db
      - DATABASE_PORT=5432
      - DATABASE_DB=superset
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - SUPERSET_CONFIG_PATH=/app/pythonpath/superset_config.py
      - SUPERSET_ENV=production
      - SUPERSET_SECRET_KEY=supersecretkey123
      - KEYCLOAK_URI=http://keycloak.local:8080
      - KEYCLOAK_CLIENT_ID=superset # generated from keycloak
      - KEYCLOAK_CLIENT_SECRET=bV5Mw6fusODe8cUt8KOyKl5BhrEMLqmh # generated from keycloak

    volumes:
      - ./superset_config.py:/app/pythonpath/superset_config.py
    depends_on:
      - redis
      - db

  keycloak:
    image: quay.io/keycloak/keycloak:26.4
    container_name: keycloak
    command: start-dev
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
      # needed for local setup
      KC_HOSTNAME: keycloak
      KC_HTTP_ENABLED: "true"
      KC_HOSTNAME_STRICT: "false"
      KC_PROXY: edge
      KC_SPI_COOKIE_DEFAULT_SAMESITE: NONE
    ports:
      - "8080:8080"

